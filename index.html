<!DOCTYPE html>
<html lang="pt"><head><meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="manifest" href="manifest.json">
<title>PitStop Pro v3</title>
<style>
body{margin:0;font-family:sans-serif;background:#0b0d10;color:#eee}
header{padding:12px;background:#111;border-bottom:1px solid #333;position:sticky;top:0}
.tabs{display:flex;gap:8px;margin-top:8px}
.tab{flex:1;text-align:center;padding:10px;background:#222;color:#aaa;border-radius:6px;cursor:pointer}
.tab.active{background:#333;color:#fff}
main{padding:12px}
.card{background:#15181c;border-radius:10px;padding:12px;margin-bottom:12px}
label{display:block;font-size:12px;margin-bottom:4px;color:#9aa}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#0e1114;color:#fff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
button{padding:10px;border-radius:8px;border:1px solid #333;background:#1d2127;color:#fff;cursor:pointer}
.primary{background:#00c853;border-color:#0a9d4b}
.danger{background:#e53935;border-color:#b71c1c}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #333;font-size:12px;text-align:left}
#map{height:300px;border:1px solid #333;border-radius:10px}
</style></head>
<body>
<header>
  <h2>üöö PitStop Pro v3</h2>
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="shifts">Shifts</div>
    <div class="tab" data-tab="fuel">Fuel</div>
    <div class="tab" data-tab="maint">Maintenance</div>
    <div class="tab" data-tab="export">Export</div>
  </div>
</header>
<main>
<section id="overview" class="view">
  <div class="card"><b>Dashboard</b><p>Total km: 0 | Turnos: 0</p></div>
</section>
<section id="shifts" class="view" style="display:none">
  <div class="card"><b>Turno</b>
    <div class="row3">
      <div><label>Cidade/Pa√≠s in√≠cio</label><input id="s_city_start"><label>Km in√≠cio</label><input id="s_km_start" type="number"></div>
      <div><label>Cidade/Pa√≠s fim</label><input id="s_city_end"><label>Km fim</label><input id="s_km_end" type="number"></div>
      <div><label>Notas</label><textarea id="s_note"></textarea></div>
    </div>
    <div class="row"><div><label>Trailer swap</label><input id="s_swap"></div><div><label>Status GPS</label><span id="gpsStatus">idle</span></div></div>
    <div class="row"><div><label>Local de Carga</label><input id="s_load"></div><div><label>Hora de Carga</label><input id="s_load_time" type="datetime-local"></div></div>
    <div class="row"><div><label>Local de Descarga</label><input id="s_unload"></div><div><label>Hora de Descarga</label><input id="s_unload_time" type="datetime-local"></div></div>
    <div id="map"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="primary" id="btnStart">Start shift (GPS)</button>
      <button class="danger" id="btnStop" disabled>Stop shift</button>
      <button id="btnLoad">Mark Load Now</button>
      <button id="btnUnload">Mark Unload Now</button>
      <button id="btnWaypoint">Add manual waypoint</button>
    </div>
  </div>
  <div class="card">
    <b>Hist√≥rico</b>
    <table id="shiftTable"><thead><tr><th>Start</th><th>End</th><th>Dist</th><th>Start City</th><th>End City</th><th></th></tr></thead><tbody></tbody></table>
  </div>
</section>
<section id="fuel" class="view" style="display:none"><div class="card">Fuel (demo)</div></section>
<section id="maint" class="view" style="display:none"><div class="card">Maintenance (demo)</div></section>
<section id="export" class="view" style="display:none"><div class="card"><button onclick="exportCSV()">Export CSV</button></div></section>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Tabs robustas
function showTab(id){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelector('.tab[data-tab="'+id+'"]').classList.add('active');document.querySelectorAll('.view').forEach(v=>v.style.display='none');document.getElementById(id).style.display='block';}
document.querySelectorAll('#tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

// DB
const DB={get:k=>JSON.parse(localStorage.getItem(k)||'[]'),set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};

// Mapa + GPS
let map=L.map('map').setView([52.1,5.1],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let line=L.polyline([],{weight:5}).addTo(map);
let watchId=null, pts=[], startTime=null;
function hav(a,b){const R=6371000,rad=x=>x*Math.PI/180;const dLat=rad(b.lat-a.lat),dLng=rad(b.lng-a.lng);const s=Math.sin(dLat/2)**2+Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*Math.sin(dLng/2)**2;return 2*R*Math.asin(s**0.5);}
function dist(){let d=0;for(let i=1;i<pts.length;i++)d+=hav(pts[i-1],pts[i]);return d/1000;}

document.getElementById('btnStart').onclick=()=>{
  if(!navigator.geolocation){alert('Sem GPS');return;}
  pts=[];line.setLatLngs([]);startTime=Date.now();document.getElementById('gpsStatus').textContent='recording';
  watchId=navigator.geolocation.watchPosition(p=>{const ll=[p.coords.latitude,p.coords.longitude];pts.push({lat:ll[0],lng:ll[1]});line.addLatLng(ll);if(pts.length===1)map.setView(ll,14);},e=>{console.log(e);},{enableHighAccuracy:true,maximumAge:1000,timeout:15000});
  document.getElementById('btnStart').disabled=true;document.getElementById('btnStop').disabled=false;
};
document.getElementById('btnStop').onclick=()=>{
  if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;}
  document.getElementById('gpsStatus').textContent='stopped';
  const rec={start_time:startTime,end_time:Date.now(),distance_km:+dist().toFixed(2),start_city:document.getElementById('s_city_start').value,end_city:document.getElementById('s_city_end').value,track:pts};
  const arr=DB.get('shifts');arr.push(rec);DB.set('shifts',arr);renderShifts();
  document.getElementById('btnStart').disabled=false;document.getElementById('btnStop').disabled=true;
};
document.getElementById('btnWaypoint').onclick=()=>{const c=map.getCenter();pts.push({lat:c.lat,lng:c.lng});line.addLatLng([c.lat,c.lng]);};

function renderShifts(){
  const tbody=document.querySelector('#shiftTable tbody');tbody.innerHTML='';
  DB.get('shifts').forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${new Date(r.start_time).toLocaleString()}</td><td>${new Date(r.end_time).toLocaleString()}</td><td>${r.distance_km} km</td><td>${r.start_city||''}</td><td>${r.end_city||''}</td><td><button onclick="view(${i})">View</button></td>`;tbody.appendChild(tr);});
}
function view(i){const r=DB.get('shifts')[i];if(!r)return;line.setLatLngs(r.track.map(p=>[p.lat,p.lng]));map.fitBounds(line.getBounds(),{padding:[20,20]});showTab('shifts');}
function exportCSV(){const a=DB.get('shifts');const rows=['start_time,end_time,distance_km,start_city,end_city'];a.forEach(r=>rows.push([r.start_time,r.end_time,r.distance_km,`"${r.start_city}"`,`"${r.end_city}"`].join(',')));const blob=new Blob([rows.join('\n')],{type:'text/csv'});const url=URL.createObjectURL(blob);const link=document.createElement('a');link.href=url;link.download='shifts.csv';link.click();URL.revokeObjectURL(url);}
renderShifts();
</script>
</body></html>
