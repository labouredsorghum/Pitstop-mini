<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0d10"/>
<title>PitStop Pro v3 FULL</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
:root{--bg:#0b0d10;--card:#15181c;--text:#e8eaed;--muted:#a1a7b3;--accent:#00c853;--danger:#e53935;--line:#2a3139}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:#0c0e11;padding:12px;border-bottom:1px solid var(--line);z-index:5}
h1{margin:0;font-size:20px}
.tabs{display:flex;gap:8px;margin-top:8px;overflow-x:auto}
.tab{flex:1;text-align:center;padding:10px;border:1px solid var(--line);border-radius:10px;background:#111317;color:#cbd5e1;cursor:pointer;white-space:nowrap}
.tab.active{background:#1f232a;color:#fff}
main{padding:12px;max-width:1100px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e1114;color:var(--text)}
textarea{min-height:70px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#15181c;color:var(--text);cursor:pointer}
.primary{background:var(--accent);border-color:#0a9d4b}
.danger{background:var(--danger);border-color:#b71c1c}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--line);font-size:12px;text-align:left}
.pill{font-size:11px;padding:3px 8px;border-radius:999px;background:#21262d;border:1px solid var(--line);color:#cfd8dc}
.center{text-align:center}
/* MAP: fixed size, non-interactive, never overlaps */
.map-wrap{width:100%;max-width:100%;border:1px solid var(--line);border-radius:12px;overflow:hidden}
#map{width:100%;height:320px}
/* disable user interaction on the map surface */
#map .leaflet-control-container{display:none}
#map, #map *{touch-action:none}
.leaflet-container{pointer-events:none}
@media (max-width:900px){.row,.row3{grid-template-columns:1fr}#map{height:280px}}
footer{font-size:11px;color:var(--muted);text-align:center;margin:16px 0}
</style>
</head>
<body>
<header>
  <h1>üöö PitStop Pro <small style="color:#94a3b8">v3-full</small></h1>
  <div class="tabs" id="topTabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="shifts">Shifts</div>
    <div class="tab" data-tab="fuel">Fuel</div>
    <div class="tab" data-tab="maint">Maintenance</div>
    <div class="tab" data-tab="export">Export</div>
  </div>
</header>
<main>

<!-- OVERVIEW -->
<section id="overview" class="view">
  <div class="card">
    <div class="row">
      <div class="card"><div>üöõ Total km</div><h2 id="ov_total_km">‚Äî</h2></div>
      <div class="card"><div>‚è±Ô∏è Horas condu√ß√£o</div><h2 id="ov_total_h">‚Äî</h2></div>
    </div>
    <div class="row">
      <div class="card"><div>üìÖ Turnos</div><h2 id="ov_turnos">‚Äî</h2></div>
      <div class="card"><div>‚ö° M√©dia km/turno</div><h2 id="ov_media">‚Äî</h2></div>
    </div>
  </div>
  <div class="card"><h3 class="center">Km por semana</h3><canvas id="bar" height="160"></canvas></div>
  <div class="card"><h3 class="center">Rotas mais frequentes</h3><canvas id="pie" height="180"></canvas></div>
</section>

<!-- SHIFTS -->
<section id="shifts" class="view" style="display:none">
  <div class="card">
    <h3>Turno</h3>
    <div class="row3">
      <div>
        <label>Cidade/Pa√≠s in√≠cio</label><input id="s_city_start" placeholder="Rotterdam, NL">
        <label>Km in√≠cio</label><input id="s_km_start" type="number" placeholder="314000">
      </div>
      <div>
        <label>Cidade/Pa√≠s fim</label><input id="s_city_end" placeholder="Milan, IT">
        <label>Km fim</label><input id="s_km_end" type="number" placeholder="314850">
      </div>
      <div>
        <label>Notas</label><textarea id="s_note" placeholder="Trailer alto, vento lateral..."></textarea>
      </div>
    </div>
    <div class="row">
      <div><label>Trailer swap</label><input id="s_swap" placeholder="Ex: Troca no km 245, trailer ABC-123"></div>
      <div><label>Status GPS</label><div id="gpsStatus" class="pill">idle</div></div>
    </div>
    <div class="row">
      <div><label>Local de Carga</label><input id="s_load" placeholder="Local"></div>
      <div><label>Hora de Carga</label><input id="s_load_time" type="datetime-local"></div>
    </div>
    <div class="row">
      <div><label>Local de Descarga</label><input id="s_unload" placeholder="Local"></div>
      <div><label>Hora de Descarga</label><input id="s_unload_time" type="datetime-local"></div>
    </div>

    <div class="map-wrap"><div id="map"></div></div>
    <div class="row" style="margin-top:8px">
      <div><span class="pill">Points:</span> <span id="gpsPoints">0</span></div>
      <div><span class="pill">Distance:</span> <span id="gpsDist">0.00 km</span></div>
      <div><span class="pill">Start:</span> <span id="startInfo">‚Äî</span></div>
      <div><span class="pill">End:</span> <span id="endInfo">‚Äî</span></div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="primary" id="btnStart">‚ñ∂Ô∏è Start shift (GPS)</button>
      <button class="danger" id="btnStop" disabled>‚èπ Stop shift</button>
      <button id="btnLoad">üì¶ Mark Load Now</button>
      <button id="btnUnload">üèÅ Mark Unload Now</button>
      <button id="btnWaypoint">‚ûï Add manual waypoint</button>
      <button id="btnClear">Clear current</button>
    </div>
  </div>

  <div class="card">
    <h3>Hist√≥rico</h3>
    <table id="shiftTable"><thead><tr>
      <th>Start</th><th>End</th><th>Duration</th><th>Distance</th><th>Start City</th><th>End City</th><th>Km Start</th><th>Km End</th><th>Load/Unload</th><th>Swap</th><th>Note</th><th></th>
    </tr></thead><tbody></tbody></table>
  </div>
</section>

<!-- FUEL -->
<section id="fuel" class="view" style="display:none">
  <div class="card">
    <h3>Fuel</h3>
    <div class="row">
      <div><label>Date & time</label><input type="datetime-local" id="f_date"></div>
      <div><label>Odometer (km)</label><input type="number" id="f_odo"></div>
    </div>
    <div class="row">
      <div><label>Liters</label><input type="number" step="0.001" id="f_liters"></div>
      <div><label>Total Price (‚Ç¨)</label><input type="number" step="0.01" id="f_total"></div>
    </div>
    <div class="row">
      <div><label>Fuel Type</label><select id="f_type"><option>95 E10</option><option>98 E5</option><option>Diesel B7</option></select></div>
      <div><label>Brand / Station</label><input id="f_brand"></div>
    </div>
    <div><label>Notes</label><input id="f_notes"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="primary" id="btnAddFuel">Add Fill-up</button>
      <button id="btnClearFuel">Clear</button>
    </div>
  </div>
  <div class="card">
    <table id="fuelTable"><thead><tr><th>Date</th><th>Odo</th><th>L</th><th>‚Ç¨</th><th>/L</th><th>Type</th><th>Brand</th><th>Œîkm</th><th>L/100</th><th></th></tr></thead><tbody></tbody></table>
  </div>
</section>

<!-- MAINT -->
<section id="maint" class="view" style="display:none">
  <div class="card">
    <h3>Maintenance</h3>
    <div class="row">
      <div><label>Task</label><input id="m_task"></div>
      <div><label>Category</label><select id="m_cat"><option>Engine</option><option>Brakes</option><option>Suspension</option><option>Tyres</option><option>Electrical</option><option>Fluids</option><option>Other</option></select></div>
    </div>
    <div class="row">
      <div><label>Done on</label><input type="date" id="m_date"></div>
      <div><label>Done at (km)</label><input type="number" id="m_km"></div>
    </div>
    <div class="row">
      <div><label>Next due (date)</label><input type="date" id="m_next_date"></div>
      <div><label>Next due (km)</label><input type="number" id="m_next_km"></div>
    </div>
    <div><label>Notes</label><input id="m_notes"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="primary" id="btnAddMaint">Add Record</button>
      <button id="btnClearMaint">Clear</button>
    </div>
  </div>
  <div class="card">
    <table id="maintTable"><thead><tr><th>Task</th><th>Cat</th><th>Done</th><th>@km</th><th>Next</th><th>Due km</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
  </div>
</section>

<!-- EXPORT -->
<section id="export" class="view" style="display:none">
  <div class="card">
    <button id="expShift">Export Shifts CSV</button>
    <button id="expFuel">Export Fuel CSV</button>
    <button id="expMaint">Export Maintenance CSV</button>
    <button class="primary" id="pdfMonth">PDF Mensal (A5)</button>
    <button class="primary" id="pdfLast">PDF √öltimo Turno (A5)</button>
    <button class="danger" id="wipe">Wipe ALL</button>
  </div>
</section>

<footer>Local-first ‚Ä¢ PWA offline ‚Ä¢ v3-full</footer>

</main>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
// --- Tabs ---
function showTab(tab){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  const t=[...document.querySelectorAll('.tab')].find(b=>b.dataset.tab===tab); if(t) t.classList.add('active');
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  const v=document.getElementById(tab); if(v){ v.style.display='block'; if(tab==='shifts'){ setTimeout(()=>map.invalidateSize(), 200); } }
}
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('#topTabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));
});

// --- DB ---
const DB={get:k=>JSON.parse(localStorage.getItem(k)||'[]'), set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};

// --- Overview ---
function computeOverview(){
  const shifts=DB.get('shifts');
  let totalKm=0,totalH=0;
  shifts.forEach(s=>{ totalKm+=s.distance_km||0; if(s.end_time&&s.start_time){ totalH+=(s.end_time-s.start_time)/3600000; }});
  const turnos=shifts.length;
  document.getElementById('ov_total_km').textContent = totalKm.toFixed(0)+' km';
  document.getElementById('ov_total_h').textContent = totalH.toFixed(1)+' h';
  document.getElementById('ov_turnos').textContent = turnos;
  document.getElementById('ov_media').textContent = (turnos? totalKm/turnos:0).toFixed(0)+' km/turno';

  let weeks={'Wk1':2800,'Wk2':3100,'Wk3':2900,'Wk4':2650};
  let routes={'Rotterdam-Milan':12,'Antwerp-Hamburg':9,'Rotterdam-Paris':7};
  new Chart(document.getElementById('bar'),{type:'bar',data:{labels:Object.keys(weeks),datasets:[{label:'Km',data:Object.values(weeks)}]},options:{plugins:{legend:{display:false}}}});
  new Chart(document.getElementById('pie'),{type:'pie',data:{labels:Object.keys(routes),datasets:[{data:Object.values(routes)}]},options:{plugins:{legend:{position:'bottom'}}}});
}

// --- Map (fixed, non-interactive) + GPS ---
let map = L.map('map', {
  zoomControl:false, scrollWheelZoom:false, doubleClickZoom:false, touchZoom:false, boxZoom:false, keyboard:false, dragging:false
}).setView([52.1,5.1],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'OSM'}).addTo(map);
let route = L.polyline([], {weight:5}).addTo(map);
let startMarker=null, endMarker=null;
let watchId=null, currentPoints=[], shiftStart=null, shiftEnd=null;

function formatTime(t){return new Date(t).toLocaleString();}
function fmtLatLng(a,b){return a.toFixed(5)+','+b.toFixed(5);}
function updateStats(){
  document.getElementById('gpsPoints').textContent=currentPoints.length;
  document.getElementById('gpsDist').textContent=(calcDistance(currentPoints)/1000).toFixed(2)+' km';
  document.getElementById('startInfo').textContent=shiftStart? formatTime(shiftStart.time)+' @ '+fmtLatLng(shiftStart.lat,shiftStart.lng):'‚Äî';
  document.getElementById('endInfo').textContent=shiftEnd? formatTime(shiftEnd.time)+' @ '+fmtLatLng(shiftEnd.lat,shiftEnd.lng):'‚Äî';
}
function calcDistance(points){ if(points.length<2) return 0; let d=0; for(let i=1;i<points.length;i++){ d+=haversine(points[i-1],points[i]); } return d; }
function haversine(a,b){ const R=6371000, toRad=x=>x*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng); const lat1=toRad(a.lat), lat2=toRad(b.lat); const x=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(x)); }

document.getElementById('btnStart').onclick=()=>{
  if(!navigator.geolocation){ alert('Sem GPS'); return; }
  currentPoints=[]; route.setLatLngs([]);
  if(startMarker){map.removeLayer(startMarker);} if(endMarker){map.removeLayer(endMarker);}
  document.getElementById('gpsStatus').textContent='recording';
  watchId=navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude}=pos.coords; const ll=[latitude,longitude];
    currentPoints.push({lat:latitude,lng:longitude,t:Date.now()}); route.addLatLng(ll);
    if(currentPoints.length===1){ shiftStart={lat:latitude,lng:longitude,time:Date.now()}; startMarker=L.marker(ll).addTo(map); map.setView(ll,14); }
    updateStats(); 
  }, err=>{ console.error(err); document.getElementById('gpsStatus').textContent='error'; }, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
  document.getElementById('btnStart').disabled=true; document.getElementById('btnStop').disabled=false;
};

document.getElementById('btnStop').onclick=()=>{
  if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  const last=currentPoints[currentPoints.length-1]; if(last){ shiftEnd={lat:last.lat,lng:last.lng,time:Date.now()}; endMarker=L.marker([last.lat,last.lng]).addTo(map); }
  document.getElementById('gpsStatus').textContent='stopped'; document.getElementById('btnStart').disabled=false; document.getElementById('btnStop').disabled=true; updateStats(); saveShift();
};

document.getElementById('btnWaypoint').onclick=()=>{ const c=map.getCenter(); currentPoints.push({lat:c.lat,lng:c.lng,t:Date.now(),manual:true}); route.addLatLng(c); updateStats(); };
document.getElementById('btnLoad').onclick=()=>{ document.getElementById('s_load_time').value=new Date().toISOString().slice(0,16); };
document.getElementById('btnUnload').onclick=()=>{ document.getElementById('s_unload_time').value=new Date().toISOString().slice(0,16); };
document.getElementById('btnClear').onclick=()=>{ currentPoints=[]; route.setLatLngs([]); if(startMarker){map.removeLayer(startMarker);startMarker=null} if(endMarker){map.removeLayer(endMarker);endMarker=null} shiftStart=null; shiftEnd=null; updateStats(); document.getElementById('gpsStatus').textContent='idle'; };

function saveShift(){
  if(!shiftStart){ alert('No start'); return; }
  const distanceKm=(calcDistance(currentPoints)/1000);
  const rec={
    start_time: shiftStart.time, start_lat:shiftStart.lat, start_lng:shiftStart.lng,
    end_time: shiftEnd?shiftEnd.time:null, end_lat: shiftEnd?shiftEnd.lat:null, end_lng: shiftEnd?shiftEnd.lng:null,
    distance_km: Number(distanceKm.toFixed(2)),
    note: document.getElementById('s_note').value.trim(),
    trailer_swap: document.getElementById('s_swap').value.trim(),
    load_place: document.getElementById('s_load').value.trim(),
    load_time: document.getElementById('s_load_time').value || null,
    unload_place: document.getElementById('s_unload').value.trim(),
    unload_time: document.getElementById('s_unload_time').value || null,
    start_city: document.getElementById('s_city_start').value.trim(),
    end_city: document.getElementById('s_city_end').value.trim(),
    km_start: Number(document.getElementById('s_km_start').value||0),
    km_end: Number(document.getElementById('s_km_end').value||0),
    track: currentPoints
  };
  const arr=DB.get('shifts'); arr.push(rec); DB.set('shifts',arr); renderShifts(); computeOverview();
}

function delShift(i){const arr=DB.get('shifts');arr.splice(i,1);DB.set('shifts',arr);renderShifts();computeOverview();}
function previewRoute(i){
  const r=DB.get('shifts')[i]; if(!r) return;
  const latlngs=r.track.map(p=>[p.lat,p.lng]); route.setLatLngs(latlngs);
  if(startMarker) map.removeLayer(startMarker); if(endMarker) map.removeLayer(endMarker);
  if(latlngs.length){ startMarker=L.marker(latlngs[0]).addTo(map); endMarker=L.marker(latlngs.at(-1)).addTo(map); map.fitBounds(route.getBounds(),{padding:[20,20]}); }
  showTab('shifts'); setTimeout(()=>map.invalidateSize(),150);
}
function renderShifts(){
  const tbody=document.querySelector('#shiftTable tbody'); tbody.innerHTML='';
  const arr=DB.get('shifts').sort((a,b)=>a.start_time-b.start_time);
  arr.forEach((r,i)=>{
    const dur=(r.end_time&&r.start_time)? msToH(r.end_time-r.start_time):'‚Äî';
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.start_time?new Date(r.start_time).toLocaleString():''}</td>
      <td>${r.end_time?new Date(r.end_time).toLocaleString():''}</td>
      <td>${dur}</td>
      <td>${(r.distance_km||0).toFixed(2)} km</td>
      <td>${r.start_city||''}</td>
      <td>${r.end_city||''}</td>
      <td>${r.km_start||''}</td>
      <td>${r.km_end||''}</td>
      <td>${r.load_place||''} / ${r.unload_place||''}</td>
      <td>${r.trailer_swap||''}</td>
      <td>${r.note||''}</td>
      <td><button onclick="previewRoute(${i})">View</button> <button onclick="delShift(${i})">Del</button></td>`;
    tbody.appendChild(tr);
  });
}
function msToH(ms){const h=ms/3600000;const H=Math.floor(h);const M=Math.round((h-H)*60);return `${H}h ${M}m`;}

// --- Fuel ---
document.getElementById('btnAddFuel').onclick=()=>{
  const rec={date:(document.getElementById('f_date').value||new Date().toISOString()).slice(0,16),odo:Number(document.getElementById('f_odo').value||0),liters:Number(document.getElementById('f_liters').value||0),total:Number(document.getElementById('f_total').value||0),type:document.getElementById('f_type').value,brand:document.getElementById('f_brand').value.trim(),notes:document.getElementById('f_notes').value.trim()};
  const arr=DB.get('fuel');arr.push(rec);DB.set('fuel',arr);renderFuel();['f_date','f_odo','f_liters','f_total','f_brand','f_notes'].forEach(i=>document.getElementById(i).value='');computeOverview();
};
document.getElementById('btnClearFuel').onclick=()=>['f_date','f_odo','f_liters','f_total','f_brand','f_notes'].forEach(i=>document.getElementById(i).value='');
function delFuel(i){const arr=DB.get('fuel');arr.splice(i,1);DB.set('fuel',arr);renderFuel();}
function renderFuel(){
  const tbody=document.querySelector('#fuelTable tbody'); tbody.innerHTML='';
  const arr=DB.get('fuel').sort((a,b)=>new Date(a.date)-new Date(b.date));
  arr.forEach((r,i)=>{
    const prev=i>0?arr[i-1]:null; const dkm=prev? (r.odo-prev.odo):0; const ppl=r.liters? (r.total/r.liters):0; const l100=(dkm>0&&r.liters>0)? (r.liters/dkm*100):0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.date.replace('T',' ')}</td><td>${r.odo||''}</td><td>${r.liters||''}</td><td>${r.total||''}</td><td>${ppl?ppl.toFixed(3):''}</td><td><span class="pill">${r.type||''}</span></td><td>${r.brand||''}</td><td>${dkm||''}</td><td>${l100?l100.toFixed(2):''}</td><td><button onclick="delFuel(${i})">Del</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- Maintenance ---
document.getElementById('btnAddMaint').onclick=()=>{
  const rec={task:document.getElementById('m_task').value.trim(),cat:document.getElementById('m_cat').value,date:document.getElementById('m_date').value,km:Number(document.getElementById('m_km').value||0),next_date:document.getElementById('m_next_date').value,next_km:Number(document.getElementById('m_next_km').value||0),notes:document.getElementById('m_notes').value.trim()};
  const arr=DB.get('maint');arr.push(rec);DB.set('maint',arr);renderMaint();['m_task','m_date','m_km','m_next_date','m_next_km','m_notes'].forEach(i=>document.getElementById(i).value='');document.getElementById('m_cat').value='Engine';
};
document.getElementById('btnClearMaint').onclick=()=>['m_task','m_date','m_km','m_next_date','m_next_km','m_notes'].forEach(i=>document.getElementById(i).value='');
function delMaint(i){const arr=DB.get('maint');arr.splice(i,1);DB.set('maint',arr);renderMaint();}
function renderMaint(){
  const tbody=document.querySelector('#maintTable tbody'); tbody.innerHTML='';
  const arr=DB.get('maint').sort((a,b)=>{if(a.date&&b.date) return new Date(a.date)-new Date(b.date); return (a.km||0)-(b.km||0)});
  arr.forEach((r,i)=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.task||''}</td><td><span class="pill">${r.cat||''}</span></td><td>${r.date||''}</td><td>${r.km||''}</td><td>${r.next_date||''}</td><td>${r.next_km||''}</td><td>${r.notes||''}</td><td><button onclick="delMaint(${i})">Del</button></td>`; tbody.appendChild(tr);
  });
}

// --- CSV + PDF ---
function toCSV(arr){if(!arr.length) return ''; const headers=Object.keys(arr[0]); const esc=v=>('\"'+String(v).replaceAll('\"','\"\"')+'\"'); const rows=[headers.join(',')]; arr.forEach(o=>rows.push(headers.map(h=>esc(o[h]??'')).join(','))); return rows.join('\n');}
function download(name,text){const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(text);a.download=name;document.body.appendChild(a);a.click();a.remove();}

document.getElementById('expShift').onclick=()=>{ const arr=DB.get('shifts').map(x=>({...x, track: JSON.stringify(x.track)})); download('shifts.csv', toCSV(arr)); };
document.getElementById('expFuel').onclick=()=> download('fuel.csv', toCSV(DB.get('fuel')));
document.getElementById('expMaint').onclick=()=> download('maint.csv', toCSV(DB.get('maint')));
document.getElementById('wipe').onclick=()=>{ if(confirm('Delete ALL data?')){ localStorage.clear(); renderAll(); computeOverview(); } };

document.getElementById('pdfLast').onclick=()=>{ const a=DB.get('shifts'); if(!a.length){alert('Sem turnos'); return;} pdfShift(a.length-1); };
document.getElementById('pdfMonth').onclick=()=>pdfMonth();

async function pdfShift(idx){
  const { jsPDF } = window.jspdf; const doc = new jsPDF({format:'a5'});
  const r = DB.get('shifts')[idx];
  if(!r){ alert('shift not found'); return; }
  doc.setFontSize(14); doc.text(`Shift Report: ${r.start_city||''} ‚Üí ${r.end_city||''}`,10,12);
  doc.setFontSize(10);
  doc.text(`Start: ${new Date(r.start_time).toLocaleString()}`,10,22);
  doc.text(`End: ${r.end_time? new Date(r.end_time).toLocaleString():'‚Äî'}`,10,28);
  doc.text(`Km: ${r.km_start||'-'} ‚Üí ${r.km_end||'-'} (Dist: ${(r.distance_km||0).toFixed(2)} km)`,10,34);
  doc.text(`Load: ${r.load_place||'-'} @ ${r.load_time||'-'}`,10,40);
  doc.text(`Unload: ${r.unload_place||'-'} @ ${r.unload_time||'-'}`,10,46);
  doc.text(`Swap: ${r.trailer_swap||'-'}`,10,52);
  doc.text(`Notes: ${r.note||'-'}`,10,58);

  // mini-mapa: screenshot da √°rea do mapa (com intera√ß√µes desativadas)
  const mapEl = document.querySelector('#map');
  const imgCanvas = await html2canvas(mapEl, {useCORS:true, backgroundColor:'#ffffff', scale:1});
  const img = imgCanvas.toDataURL('image/png');
  doc.addImage(img,'PNG',10,64,120,70);
  doc.save('shift.pdf');
}

async function pdfMonth(){
  const { jsPDF } = window.jspdf; const doc = new jsPDF({format:'a5'});
  const arr=DB.get('shifts'); doc.setFontSize(14); doc.text('Monthly Report',10,12);
  let totalKm=0,totalH=0; arr.forEach(s=>{ totalKm+=s.distance_km||0; if(s.end_time&&s.start_time){ totalH+=(s.end_time-s.start_time)/3600000; }});
  doc.setFontSize(10); doc.text(`Turnos: ${arr.length}`,10,20); doc.text(`Total km: ${totalKm.toFixed(0)}`,10,26); doc.text(`Horas: ${totalH.toFixed(1)}`,10,32);
  let y=40; arr.slice(-12).forEach(s=>{ doc.text(`${new Date(s.start_time).toLocaleDateString()} ${s.start_city||''}‚Üí${s.end_city||''} - ${(s.distance_km||0).toFixed(0)} km`,10,y); y+=6; if(y>130){ doc.addPage(); y=14; } });
  doc.save('monthly.pdf');
}

// --- Init ---
function renderAll(){renderShifts();renderFuel();renderMaint();}
renderAll(); computeOverview();
</script>
</body>
</html>
